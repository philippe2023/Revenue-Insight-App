{% extends "base.html" %}

{% block title %}Hotel Rankings - Hotel Event Planning{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-3">Hotel Performance Rankings</h1>
                <p class="lead mb-4">Compare and rank hotels based on key performance indicators including occupancy, ADR, and revenue metrics.</p>
            </div>
            <div class="col-lg-4 text-end">
                <i class="fas fa-trophy fa-5x text-warning"></i>
            </div>
        </div>
    </div>
</section>

<div class="container">
    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Ranking Filters
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="rankingType" class="form-label">Data Type</label>
                            <select class="form-select" id="rankingType" onchange="updateRankings()">
                                <option value="actual">Actual Performance</option>
                                <option value="forecast">Forecast Performance</option>
                                <option value="impact">Impact (Actual vs Forecast)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="metric" class="form-label">KPI Metric</label>
                            <select class="form-select" id="metric" onchange="updateRankings()">
                                <option value="revenue">Revenue</option>
                                <option value="adr">ADR (Average Daily Rate)</option>
                                <option value="occupancy">Occupancy %</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="period" class="form-label">Time Period</label>
                            <select class="form-select" id="period" onchange="updateRankings()">
                                <option value="30">Last 30 Days</option>
                                <option value="60">Last 60 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="365" selected>Last Year</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="updateRankings()">
                                <i class="fas fa-refresh me-2"></i>Update Rankings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading ranking data...</p>
    </div>

    <!-- Rankings Table -->
    <div id="rankingsContainer" class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ol me-2"></i>Hotel Rankings
                    </h5>
                    <span id="rankingCriteria" class="badge bg-primary">Revenue - Actual Performance - Last 30 Days</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rank</th>
                                    <th>Hotel</th>
                                    <th>City</th>
                                    <th>Rooms</th>
                                    <th id="valueHeader">Value</th>
                                    <th>Data Points</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rankingsTableBody">
                                <!-- Rankings will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expanded Chart Modal -->
    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalTitle">Hotel Performance Chart</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="chartLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading chart...</span>
                        </div>
                    </div>
                    <div id="chartContainer" style="display: none;">
                        <canvas id="performanceChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Recommendations Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Performance Insights
                    </h5>
                </div>
                <div class="card-body">
                    <div id="performanceInsights">
                        <p class="text-muted">Select a hotel from the rankings to view personalized performance recommendations.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hero-section {
    background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-info) 100%);
    color: white;
    padding: 4rem 0;
    margin-bottom: 2rem;
}

.rank-badge {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
}

.rank-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #333;
}

.rank-silver {
    background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
    color: #333;
}

.rank-bronze {
    background: linear-gradient(135deg, #CD7F32, #B8860B);
    color: white;
}

.rank-default {
    background: var(--bs-secondary);
    color: white;
}

.value-positive {
    color: var(--bs-success);
    font-weight: bold;
}

.value-negative {
    color: var(--bs-danger);
    font-weight: bold;
}

.chart-container {
    height: 300px;
    position: relative;
}

.recommendation-card {
    border-left: 4px solid var(--bs-primary);
    margin-bottom: 1rem;
}

.priority-high {
    border-left-color: var(--bs-danger) !important;
}

.priority-medium {
    border-left-color: var(--bs-warning) !important;
}

.priority-low {
    border-left-color: var(--bs-info) !important;
}
</style>

<script>
let currentRankings = [];

document.addEventListener('DOMContentLoaded', function() {
    updateRankings();
});

function updateRankings() {
    const rankingType = document.getElementById('rankingType').value;
    const metric = document.getElementById('metric').value;
    const period = document.getElementById('period').value;
    
    // Show loading
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('rankingsContainer').style.display = 'none';
    
    // Update criteria badge
    let periodText = '';
    if (period === 'all') {
        periodText = 'All Time';
    } else if (period === '365') {
        periodText = 'Last Year';
    } else {
        periodText = `Last ${period} Days`;
    }
    const criteriaText = `${capitalizeFirst(metric)} - ${capitalizeFirst(rankingType)} Performance - ${periodText}`;
    document.getElementById('rankingCriteria').textContent = criteriaText;
    
    // Update table header
    let valueHeaderText = '';
    if (rankingType === 'actual') {
        valueHeaderText = metric === 'revenue' ? 'Total Revenue' : 
                         metric === 'adr' ? 'Avg ADR' : 'Avg Occupancy %';
    } else if (rankingType === 'forecast') {
        valueHeaderText = metric === 'revenue' ? 'Forecast Revenue' : 
                         metric === 'adr' ? 'Forecast ADR' : 'Forecast Occupancy %';
    } else {
        valueHeaderText = metric === 'revenue' ? 'Revenue Impact' : 
                         metric === 'adr' ? 'ADR Impact' : 'Occupancy Impact';
    }
    document.getElementById('valueHeader').textContent = valueHeaderText;
    
    // Fetch rankings data
    fetch(`/get-hotel-rankings-data?type=${rankingType}&metric=${metric}&period=${period}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentRankings = data.rankings;
                displayRankings(data.rankings, data.criteria);
            } else {
                console.error('Failed to load rankings:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading rankings:', error);
        })
        .finally(() => {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('rankingsContainer').style.display = 'block';
        });
}

function displayRankings(rankings, criteria) {
    const tbody = document.getElementById('rankingsTableBody');
    tbody.innerHTML = '';
    
    rankings.forEach(hotel => {
        const row = document.createElement('tr');
        
        // Rank badge
        let rankClass = 'rank-default';
        if (hotel.rank === 1) rankClass = 'rank-gold';
        else if (hotel.rank === 2) rankClass = 'rank-silver';
        else if (hotel.rank === 3) rankClass = 'rank-bronze';
        
        // Format value based on metric
        let formattedValue = '';
        if (criteria.metric === 'revenue') {
            formattedValue = `$${hotel.value.toLocaleString()}`;
        } else if (criteria.metric === 'adr') {
            formattedValue = `$${hotel.value.toFixed(2)}`;
        } else {
            formattedValue = `${hotel.value.toFixed(1)}%`;
        }
        
        // Add positive/negative styling for impact
        let valueClass = '';
        if (criteria.type === 'impact') {
            valueClass = hotel.value >= 0 ? 'value-positive' : 'value-negative';
            if (hotel.value >= 0) formattedValue = '+' + formattedValue;
        }
        
        row.innerHTML = `
            <td>
                <div class="rank-badge ${rankClass}">
                    ${hotel.rank}
                </div>
            </td>
            <td>
                <strong>${hotel.hotel_name}</strong>
            </td>
            <td>${hotel.city}</td>
            <td>${hotel.inventory}</td>
            <td class="${valueClass}">${formattedValue}</td>
            <td>
                <span class="badge bg-secondary">${hotel.data_points || 0}</span>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="showHotelChart(${hotel.hotel_id}, '${hotel.hotel_name}')">
                        <i class="fas fa-chart-line me-1"></i>Chart
                    </button>
                    <button class="btn btn-outline-success" onclick="loadRecommendations(${hotel.hotel_id})">
                        <i class="fas fa-lightbulb me-1"></i>Insights  
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function showHotelChart(hotelId, hotelName) {
    const rankingType = document.getElementById('rankingType').value;
    const metric = document.getElementById('metric').value;
    const period = document.getElementById('period').value;
    
    document.getElementById('chartModalTitle').textContent = `${hotelName} - ${capitalizeFirst(metric)} Performance`;
    document.getElementById('chartLoading').style.display = 'block';
    document.getElementById('chartContainer').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('chartModal'));
    modal.show();
    
    // Fetch chart data
    fetch(`/get-hotel-ranking-chart/${hotelId}?type=${rankingType}&metric=${metric}&period=${period}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderChart(data.chart_data, metric);
            }
        })
        .catch(error => {
            console.error('Error loading chart:', error);
        });
}

function renderChart(chartData, metric) {
    document.getElementById('chartLoading').style.display = 'none';
    document.getElementById('chartContainer').style.display = 'block';
    
    const canvas = document.getElementById('performanceChart');
    const ctx = canvas.getContext('2d');
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (chartData.length === 0) {
        ctx.font = '20px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('No data available for chart', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    // Draw actual chart
    const padding = 60;
    const chartWidth = canvas.width - (padding * 2);
    const chartHeight = canvas.height - (padding * 2);
    
    // Find min/max values
    const values = chartData.map(d => d.value);
    const minValue = Math.min(...values);
    const maxValue = Math.max(...values);
    const valueRange = maxValue - minValue || 1;
    
    // Draw axes
    ctx.strokeStyle = '#ccc';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, padding + chartHeight);
    ctx.lineTo(padding + chartWidth, padding + chartHeight);
    ctx.stroke();
    
    // Draw title
    ctx.font = 'bold 16px Arial';
    ctx.fillStyle = '#333';
    ctx.textAlign = 'center';
    ctx.fillText(`${capitalizeFirst(metric)} Performance`, canvas.width / 2, 30);
    
    // Draw data points and lines
    if (chartData.length > 1) {
        ctx.strokeStyle = '#007bff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        chartData.forEach((point, index) => {
            const x = padding + (index / (chartData.length - 1)) * chartWidth;
            const y = padding + chartHeight - ((point.value - minValue) / valueRange) * chartHeight;
            
            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
            
            // Draw data point
            ctx.fillStyle = '#007bff';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        });
        
        ctx.stroke();
    }
    
    // Draw value labels
    ctx.font = '12px Arial';
    ctx.fillStyle = '#666';
    ctx.textAlign = 'right';
    
    // Y-axis labels
    for (let i = 0; i <= 4; i++) {
        const value = minValue + (valueRange * i / 4);
        const y = padding + chartHeight - (i / 4) * chartHeight;
        let displayValue = '';
        
        if (metric === 'revenue') {
            displayValue = '$' + (value / 1000).toFixed(0) + 'k';
        } else if (metric === 'adr') {
            displayValue = '$' + value.toFixed(0);
        } else {
            displayValue = value.toFixed(1) + '%';
        }
        
        ctx.fillText(displayValue, padding - 10, y + 4);
    }
    
    // X-axis labels (show first, middle, last)
    ctx.textAlign = 'center';
    if (chartData.length > 0) {
        ctx.fillText(chartData[0].label, padding, padding + chartHeight + 20);
        if (chartData.length > 2) {
            const midIndex = Math.floor(chartData.length / 2);
            const x = padding + (midIndex / (chartData.length - 1)) * chartWidth;
            ctx.fillText(chartData[midIndex].label, x, padding + chartHeight + 20);
        }
        if (chartData.length > 1) {
            ctx.fillText(chartData[chartData.length - 1].label, padding + chartWidth, padding + chartHeight + 20);
        }
    }
}

function loadRecommendations(hotelId) {
    const insightsContainer = document.getElementById('performanceInsights');
    insightsContainer.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Loading recommendations...';
    
    fetch(`/generate-performance-recommendations/${hotelId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRecommendations(data.recommendations, data.hotel_name);
            } else {
                insightsContainer.innerHTML = '<p class="text-danger">Failed to load recommendations.</p>';
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            insightsContainer.innerHTML = '<p class="text-danger">Error loading recommendations.</p>';
        });
}

function displayRecommendations(recommendations, hotelName) {
    const container = document.getElementById('performanceInsights');
    
    if (recommendations.length === 0) {
        container.innerHTML = `<p class="text-muted">No specific recommendations available for ${hotelName} at this time.</p>`;
        return;
    }
    
    let html = `<h6 class="mb-3">Recommendations for ${hotelName}</h6>`;
    
    recommendations.forEach(rec => {
        html += `
            <div class="card recommendation-card priority-${rec.priority} mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-1">${rec.title}</h6>
                        <span class="badge bg-${rec.priority === 'high' ? 'danger' : rec.priority === 'medium' ? 'warning' : 'info'}">${rec.priority} priority</span>
                    </div>
                    <p class="card-text text-muted mb-2">${rec.description}</p>
                    <div class="recommended-actions">
                        <strong>Recommended Actions:</strong>
                        <ul class="mt-1 mb-0">
                            ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}
</script>
{% endblock %}