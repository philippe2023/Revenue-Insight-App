{% extends "base.html" %}

{% block title %}Monthly Forecast - {{ hotel.hotel_name }} - {{ super() }}{% endblock %}

{% block extra_head %}
<style>
.forecast-hero {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    padding: 40px 0;
    margin-top: -24px;
    border-radius: 0 0 30px 30px;
}

[data-bs-theme="dark"] .forecast-hero {
    background: linear-gradient(135deg, rgba(44, 62, 80, 0.3) 0%, rgba(52, 152, 219, 0.1) 100%);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    background: var(--bs-border-color);
    border-radius: 15px;
    padding: 2px;
    overflow: hidden;
}

.calendar-day {
    background: var(--bs-body-bg);
    min-height: 120px;
    padding: 8px;
    position: relative;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.calendar-day:hover {
    background: rgba(102, 126, 234, 0.05);
    transform: translateY(-1px);
}

.calendar-day.weekend {
    background: rgba(255, 193, 7, 0.1);
}

.calendar-day.has-event {
    background: rgba(102, 126, 234, 0.1);
    border: 2px solid rgba(102, 126, 234, 0.3);
}

.day-number {
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--bs-body-color);
}

.day-name {
    font-size: 0.7rem;
    color: var(--bs-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.event-indicator {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #dc3545;
}

.forecast-inputs {
    margin-top: 8px;
}

.forecast-input {
    width: 100%;
    font-size: 0.75rem;
    padding: 2px 4px;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    margin-bottom: 2px;
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
}

.forecast-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.1rem rgba(102, 126, 234, 0.25);
}

.event-badge {
    font-size: 0.6rem;
    padding: 1px 4px;
    margin-bottom: 4px;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.month-nav {
    display: flex;
    align-items: center;
    justify-content: between;
    margin-bottom: 30px;
}

.btn-custom {
    border-radius: 50px;
    padding: 10px 25px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

.btn-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.saving-indicator {
    display: none;
    color: var(--bs-success);
    font-weight: 600;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 10px;
}

.calendar-header-day {
    text-align: center;
    font-weight: bold;
    padding: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="forecast-hero">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('hotel_detail', hotel_id=hotel.id) }}">{{ hotel.hotel_name }}</a></li>
                <li class="breadcrumb-item active">Monthly Forecast</li>
            </ol>
        </nav>
        
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-6 fw-bold mb-2">
                    <i class="fas fa-calendar-alt me-3"></i>
                    Monthly Forecast
                </h1>
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <h4 class="mb-0">
                        <a href="{{ url_for('hotel_detail', hotel_id=hotel.id) }}" class="text-decoration-none text-primary">
                            {{ hotel.hotel_name }}
                            <i class="fas fa-external-link-alt fa-xs ms-1"></i>
                        </a>
                    </h4>
                    <span class="badge bg-primary fs-6 px-3 py-2">{{ hotel.city }}</span>
                    <span class="badge bg-success fs-6 px-3 py-2">
                        <i class="fas fa-bed me-1"></i>{{ hotel.inventory }} rooms
                    </span>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="btn-group">
                    <a href="{{ url_for('download_monthly_template', hotel_id=hotel.id) }}?month={{ selected_month.strftime('%Y-%m') }}" 
                       class="btn btn-success btn-custom">
                        <i class="fas fa-download me-2"></i>Download Template
                    </a>
                    <button type="button" class="btn btn-primary btn-custom" onclick="document.getElementById('uploadInput').click()">
                        <i class="fas fa-upload me-2"></i>Upload Excel
                    </button>
                    <button type="button" class="btn btn-warning btn-custom" onclick="resetMonthlyForecasts()">
                        <i class="fas fa-undo me-2"></i>Reset Month
                    </button>
                    <button type="button" class="btn btn-info btn-custom" onclick="validateForecastData()">
                        <i class="fas fa-check-circle me-2"></i>Validate Data
                    </button>
                </div>
                <input type="file" id="uploadInput" accept=".xlsx,.xls" style="display: none;" onchange="uploadExcelFile()">
            </div>
        </div>
    </div>
</section>

<div class="container">
    <!-- Month Navigation -->
    <div class="month-nav">
        <div class="d-flex align-items-center">
            <a href="{{ url_for('hotel_monthly_forecast', hotel_id=hotel.id) }}?month={{ prev_month.strftime('%Y-%m') }}" 
               class="btn btn-outline-primary me-3">
                <i class="fas fa-chevron-left me-2"></i>Previous Month
            </a>
            <h3 class="mb-0 me-3">{{ month_name }}</h3>
            <a href="{{ url_for('hotel_monthly_forecast', hotel_id=hotel.id) }}?month={{ next_month.strftime('%Y-%m') }}" 
               class="btn btn-outline-primary">
                Next Month<i class="fas fa-chevron-right ms-2"></i>
            </a>
        </div>
        <div class="saving-indicator">
            <i class="fas fa-check-circle me-2"></i>Saved!
        </div>
    </div>

    <!-- Events Summary -->
    {% if events_in_month %}
    <div class="alert alert-info mb-4">
        <h6><i class="fas fa-calendar-check me-2"></i>Events this month:</h6>
        <div class="d-flex flex-wrap gap-2">
            {% for event in events_in_month %}
            <span class="badge bg-primary">
                {{ event.event_name }} ({{ event.start_date.strftime('%m/%d') }} - {{ event.end_date.strftime('%m/%d') }})
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Calendar Header -->
    <div class="calendar-header">
        <div class="calendar-header-day">Sunday</div>
        <div class="calendar-header-day">Monday</div>
        <div class="calendar-header-day">Tuesday</div>
        <div class="calendar-header-day">Wednesday</div>
        <div class="calendar-header-day">Thursday</div>
        <div class="calendar-header-day">Friday</div>
        <div class="calendar-header-day">Saturday</div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
        <!-- Empty cells for days before month start -->
        {% for i in range((calendar_days[0].date.weekday() + 1) % 7) %}
        <div class="calendar-day"></div>
        {% endfor %}
        
        <!-- Calendar days -->
        {% for day in calendar_days %}
        <div class="calendar-day {% if day.is_weekend %}weekend{% endif %} {% if day.events %}has-event{% endif %}"
             data-date="{{ day.date_str }}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="day-name">{{ day.day_of_week }}</div>
                    <div class="day-number">{{ day.day_number }}</div>
                </div>
                {% if day.events %}
                <div class="event-indicator" title="Event day"></div>
                {% endif %}
            </div>
            
            <!-- Event badges -->
            {% for event in day.events %}
            <span class="badge bg-danger event-badge" title="{{ event.event_name }}">
                {{ event.event_name[:10] }}{% if event.event_name|length > 10 %}...{% endif %}
            </span>
            {% endfor %}
            
            <!-- Forecast inputs -->
            <div class="forecast-inputs">
                <input type="number" 
                       class="forecast-input" 
                       placeholder="Revenue"
                       data-type="revenue"
                       data-date="{{ day.date_str }}"
                       value="{{ day.forecast.revenue if day.forecast else '' }}"
                       onchange="saveForecastData(this)">
                <input type="number" 
                       class="forecast-input" 
                       placeholder="ADR"
                       data-type="adr"
                       data-date="{{ day.date_str }}"
                       value="{{ day.forecast.adr if day.forecast else '' }}"
                       onchange="saveForecastData(this)">
                <input type="number" 
                       class="forecast-input" 
                       placeholder="Occ %"
                       data-type="occupancy"
                       data-date="{{ day.date_str }}"
                       value="{{ day.forecast.occupancy if day.forecast else '' }}"
                       onchange="saveForecastData(this)">
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Performance Recommendations -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Performance Recommendations
                    </h5>
                    <button class="btn btn-outline-success btn-sm" onclick="loadPerformanceRecommendations()">
                        <i class="fas fa-refresh me-2"></i>Generate Insights
                    </button>
                </div>
                <div class="card-body">
                    <div id="recommendationsContainer">
                        <p class="text-muted">Click "Generate Insights" to get personalized performance recommendations for this hotel.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Validation Results -->
    <div id="validationResults" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Data Validation Results
                    </h5>
                </div>
                <div class="card-body">
                    <div id="validationContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actual vs Forecast Comparison -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Actual vs Forecast Analysis
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadActualsComparison()">
                        <i class="fas fa-refresh me-2"></i>Refresh Data
                    </button>
                </div>
                <div class="card-body">
                    <div id="actualsLoading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading actual data...</p>
                    </div>
                    
                    <div id="actualsComparison" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Revenue</th>
                                        <th>Revenue Var</th>
                                        <th>ADR</th>
                                        <th>ADR Var</th>
                                        <th>Occupancy %</th>
                                        <th>Occ Var</th>
                                    </tr>
                                </thead>
                                <tbody id="comparisonTableBody">
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Summary Cards -->
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Revenue Variance</h6>
                                        <h4 id="revenueSummary" class="mb-0">-</h4>
                                        <small class="text-muted">Actual vs Forecast</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">ADR Variance</h6>
                                        <h4 id="adrSummary" class="mb-0">-</h4>
                                        <small class="text-muted">Actual vs Forecast</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Occupancy Variance</h6>
                                        <h4 id="occupancySummary" class="mb-0">-</h4>
                                        <small class="text-muted">Actual vs Forecast</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="noActualsMessage" class="text-center py-4">
                        <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No actual data available for this month. Upload actual data through the Analytics Dashboard to see comparisons.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Legend & Instructions</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="event-indicator me-2"></div>
                                <span>Event Day</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div style="width: 20px; height: 20px; background: rgba(255, 193, 7, 0.3); border-radius: 4px;" class="me-2"></div>
                                <span>Weekend</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Manual Entry:</strong> Enter Revenue, ADR, and Occupancy % directly in calendar cells.<br>
                                <strong>Excel Upload:</strong> Download template, fill data, and upload back for bulk updates.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function saveForecastData(input) {
    const date = input.dataset.date;
    const type = input.dataset.type;
    const value = parseFloat(input.value) || null;
    
    // Show saving indicator
    const indicator = document.querySelector('.saving-indicator');
    indicator.style.display = 'inline-block';
    
    fetch('/save-monthly-forecast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            hotel_id: {{ hotel.id }},
            date: date,
            type: type,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            indicator.innerHTML = '<i class="fas fa-check-circle me-2"></i>Saved!';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        } else {
            indicator.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error saving';
            indicator.style.color = 'var(--bs-danger)';
            setTimeout(() => {
                indicator.style.display = 'none';
                indicator.style.color = 'var(--bs-success)';
                indicator.innerHTML = '<i class="fas fa-check-circle me-2"></i>Saved!';
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        indicator.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Network error';
        indicator.style.color = 'var(--bs-danger)';
    });
}

function uploadExcelFile() {
    const fileInput = document.getElementById('uploadInput');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Show loading state
    const indicator = document.querySelector('.saving-indicator');
    indicator.style.display = 'inline-block';
    indicator.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
    
    fetch('/upload-monthly-forecast/{{ hotel.id }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            indicator.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + data.message;
            setTimeout(() => {
                location.reload(); // Reload to show updated data
            }, 2000);
        } else {
            indicator.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + data.message;
            indicator.style.color = 'var(--bs-danger)';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        indicator.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Upload failed';
        indicator.style.color = 'var(--bs-danger)';
    });
    
    // Reset file input
    fileInput.value = '';
}

function loadActualsComparison() {
    const loading = document.getElementById('actualsLoading');
    const comparison = document.getElementById('actualsComparison');
    const noData = document.getElementById('noActualsMessage');
    
    loading.style.display = 'block';
    comparison.style.display = 'none';
    noData.style.display = 'none';
    
    fetch('/get-monthly-actuals/{{ hotel.id }}?month={{ selected_month.strftime('%Y-%m') }}')
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success && data.data.length > 0) {
                displayActualsComparison(data.data);
                comparison.style.display = 'block';
            } else {
                noData.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loading.style.display = 'none';
            noData.style.display = 'block';
        });
}

function displayActualsComparison(data) {
    const tbody = document.getElementById('comparisonTableBody');
    tbody.innerHTML = '';
    
    let totalRevenueDiff = 0;
    let totalAdrDiff = 0;
    let totalOccDiff = 0;
    let count = 0;
    
    data.forEach(item => {
        const revenueDiff = item.actual_revenue - item.forecast_revenue;
        const adrDiff = item.actual_adr - item.forecast_adr;
        const occDiff = item.actual_occupancy - item.forecast_occupancy;
        
        totalRevenueDiff += revenueDiff;
        totalAdrDiff += adrDiff;
        totalOccDiff += occDiff;
        count++;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(item.date).toLocaleDateString()}</td>
            <td>
                <div>A: $${item.actual_revenue.toLocaleString()}</div>
                <div>F: $${item.forecast_revenue.toLocaleString()}</div>
            </td>
            <td class="${revenueDiff >= 0 ? 'text-success' : 'text-danger'}">
                ${revenueDiff >= 0 ? '+' : ''}$${revenueDiff.toLocaleString()}
            </td>
            <td>
                <div>A: $${item.actual_adr.toFixed(2)}</div>
                <div>F: $${item.forecast_adr.toFixed(2)}</div>
            </td>
            <td class="${adrDiff >= 0 ? 'text-success' : 'text-danger'}">
                ${adrDiff >= 0 ? '+' : ''}$${adrDiff.toFixed(2)}
            </td>
            <td>
                <div>A: ${item.actual_occupancy.toFixed(1)}%</div>
                <div>F: ${item.forecast_occupancy.toFixed(1)}%</div>
            </td>
            <td class="${occDiff >= 0 ? 'text-success' : 'text-danger'}">
                ${occDiff >= 0 ? '+' : ''}${occDiff.toFixed(1)}%
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update summary cards
    const avgRevenueDiff = totalRevenueDiff / count;
    const avgAdrDiff = totalAdrDiff / count;
    const avgOccDiff = totalOccDiff / count;
    
    document.getElementById('revenueSummary').innerHTML = 
        `<span class="${avgRevenueDiff >= 0 ? 'text-success' : 'text-danger'}">
            ${avgRevenueDiff >= 0 ? '+' : ''}$${avgRevenueDiff.toLocaleString()}
        </span>`;
    
    document.getElementById('adrSummary').innerHTML = 
        `<span class="${avgAdrDiff >= 0 ? 'text-success' : 'text-danger'}">
            ${avgAdrDiff >= 0 ? '+' : ''}$${avgAdrDiff.toFixed(2)}
        </span>`;
    
    document.getElementById('occupancySummary').innerHTML = 
        `<span class="${avgOccDiff >= 0 ? 'text-success' : 'text-danger'}">
            ${avgOccDiff >= 0 ? '+' : ''}${avgOccDiff.toFixed(1)}%
        </span>`;
}

function validateForecastData() {
    const indicator = document.querySelector('.saving-indicator');
    indicator.style.display = 'inline-block';
    indicator.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Validating...';
    
    fetch('/validate-forecast-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            hotel_id: {{ hotel.id }},
            month: '{{ selected_month.strftime('%Y-%m') }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayValidationResults(data.validation_results);
            indicator.innerHTML = '<i class="fas fa-check-circle me-2"></i>Validation complete';
        } else {
            indicator.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Validation failed';
            indicator.style.color = 'var(--bs-danger)';
        }
        
        setTimeout(() => {
            indicator.style.display = 'none';
            indicator.style.color = '';
        }, 3000);
    })
    .catch(error => {
        console.error('Error:', error);
        indicator.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Validation error';
        indicator.style.color = 'var(--bs-danger)';
    });
}

function displayValidationResults(results) {
    const container = document.getElementById('validationResults');
    const content = document.getElementById('validationContent');
    
    if (results.total_issues === 0) {
        content.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Validation Passed!</strong> No issues found with your forecast data.
            </div>
        `;
    } else {
        let html = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Validation Issues Found:</strong> ${results.total_issues} issue(s) detected.
            </div>
        `;
        
        if (results.errors.length > 0) {
            html += `
                <h6 class="text-danger mb-3">
                    <i class="fas fa-times-circle me-2"></i>Errors (${results.errors.length})
                </h6>
                <div class="row">
            `;
            results.errors.forEach(error => {
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card border-danger">
                            <div class="card-body p-3">
                                <h6 class="card-title text-danger mb-1">${error.type}</h6>
                                <p class="card-text small mb-1">${error.message}</p>
                                <small class="text-muted">Date: ${error.date}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        if (results.warnings.length > 0) {
            html += `
                <h6 class="text-warning mb-3 mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>Warnings (${results.warnings.length})
                </h6>
                <div class="row">
            `;
            results.warnings.forEach(warning => {
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card border-warning">
                            <div class="card-body p-3">
                                <h6 class="card-title text-warning mb-1">${warning.type}</h6>
                                <p class="card-text small mb-1">${warning.message}</p>
                                <small class="text-muted">Date: ${warning.date}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        content.innerHTML = html;
    }
    
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}

function loadPerformanceRecommendations() {
    const container = document.getElementById('recommendationsContainer');
    container.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Loading recommendations...';
    
    fetch('/generate-performance-recommendations/{{ hotel.id }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPerformanceRecommendations(data.recommendations);
            } else {
                container.innerHTML = '<p class="text-danger">Failed to load recommendations.</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = '<p class="text-danger">Error loading recommendations.</p>';
        });
}

function displayPerformanceRecommendations(recommendations) {
    const container = document.getElementById('recommendationsContainer');
    
    if (recommendations.length === 0) {
        container.innerHTML = '<p class="text-muted">No specific recommendations available at this time. Your hotel performance looks good!</p>';
        return;
    }
    
    let html = '';
    recommendations.forEach(rec => {
        html += `
            <div class="card mb-3 border-start border-4 border-${rec.priority === 'high' ? 'danger' : rec.priority === 'medium' ? 'warning' : 'info'}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-1">
                            <i class="fas fa-${rec.category === 'Revenue' ? 'dollar-sign' : rec.category === 'Occupancy' ? 'bed' : rec.category === 'ADR' ? 'chart-line' : 'chart-bar'} me-2"></i>
                            ${rec.title}
                        </h6>
                        <span class="badge bg-${rec.priority === 'high' ? 'danger' : rec.priority === 'medium' ? 'warning' : 'info'}">${rec.priority} priority</span>
                    </div>
                    <p class="card-text text-muted mb-2">${rec.description}</p>
                    <div class="recommended-actions">
                        <strong>Recommended Actions:</strong>
                        <ul class="mt-1 mb-0">
                            ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Auto-load actuals comparison on page load
document.addEventListener('DOMContentLoaded', function() {
    loadActualsComparison();
});

function resetMonthlyForecasts() {
    if (confirm('Are you sure you want to reset all forecasts for this month? This action cannot be undone.')) {
        fetch('/reset-monthly-forecasts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                hotel_id: {{ hotel.id }},
                month: '{{ selected_month.strftime('%Y-%m') }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error resetting forecasts');
            }
        });
    }
}
</script>
{% endblock %}