{% extends "base.html" %}

{% block title %}Advanced Analytics - {{ super() }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <h2>
            <i class="fas fa-chart-bar me-2"></i>Advanced Analytics & Reporting
        </h2>
        <p class="text-muted">Comprehensive performance insights and data-driven analytics</p>
    </div>
    <div class="col-md-6">
        <form method="GET" class="d-flex gap-2">
            <select name="hotel_filter" class="form-control form-control-sm">
                <option value="">All Hotels</option>
                {% for hotel in hotels %}
                <option value="{{ hotel.hotel_code }}" {% if selected_hotel == hotel.hotel_code %}selected{% endif %}>
                    {{ hotel.hotel_code }} - {{ hotel.hotel_name }}
                </option>
                {% endfor %}
            </select>
            <input type="date" name="date_from" value="{{ date_from }}" class="form-control form-control-sm">
            <input type="date" name="date_to" value="{{ date_to }}" class="form-control form-control-sm">
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="fas fa-search"></i> Filter
            </button>
        </form>
    </div>
</div>

<!-- Portfolio Performance Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-building me-2"></i>Portfolio Performance Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-primary">${{ "{:,.0f}".format(analytics_data.portfolio.total_revenue_ty) }}</h4>
                            <p class="mb-1">Total Revenue (TY)</p>
                            <small class="text-muted">vs ${{ "{:,.0f}".format(analytics_data.portfolio.total_revenue_stly) }} STLY</small>
                            <div class="mt-2">
                                {% if analytics_data.portfolio.revenue_growth >= 0 %}
                                <span class="badge bg-success">+{{ "{:.1f}".format(analytics_data.portfolio.revenue_growth) }}%</span>
                                {% else %}
                                <span class="badge bg-danger">{{ "{:.1f}".format(analytics_data.portfolio.revenue_growth) }}%</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-success">{{ "{:,.0f}".format(analytics_data.portfolio.total_room_nights_ty) }}</h4>
                            <p class="mb-1">Room Nights (TY)</p>
                            <small class="text-muted">vs {{ "{:,.0f}".format(analytics_data.portfolio.total_room_nights_stly) }} STLY</small>
                            <div class="mt-2">
                                {% if analytics_data.portfolio.room_nights_growth >= 0 %}
                                <span class="badge bg-success">+{{ "{:.1f}".format(analytics_data.portfolio.room_nights_growth) }}%</span>
                                {% else %}
                                <span class="badge bg-danger">{{ "{:.1f}".format(analytics_data.portfolio.room_nights_growth) }}%</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-info">${{ "{:.0f}".format(analytics_data.portfolio.avg_adr_ty) }}</h4>
                            <p class="mb-1">Average ADR (TY)</p>
                            <small class="text-muted">vs ${{ "{:.0f}".format(analytics_data.portfolio.avg_adr_stly) }} STLY</small>
                            <div class="mt-2">
                                {% if analytics_data.portfolio.adr_growth >= 0 %}
                                <span class="badge bg-success">+{{ "{:.1f}".format(analytics_data.portfolio.adr_growth) }}%</span>
                                {% else %}
                                <span class="badge bg-danger">{{ "{:.1f}".format(analytics_data.portfolio.adr_growth) }}%</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-warning">{{ "{:.1f}".format(analytics_data.portfolio.occupancy_ty) }}%</h4>
                            <p class="mb-1">Occupancy (TY)</p>
                            <small class="text-muted">vs {{ "{:.1f}".format(analytics_data.portfolio.occupancy_stly) }}% STLY</small>
                            <div class="mt-2">
                                {% if analytics_data.portfolio.occupancy_growth >= 0 %}
                                <span class="badge bg-success">+{{ "{:.1f}".format(analytics_data.portfolio.occupancy_growth) }}pp</span>
                                {% else %}
                                <span class="badge bg-danger">{{ "{:.1f}".format(analytics_data.portfolio.occupancy_growth) }}pp</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Revenue Trends Chart -->
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-line-chart me-2"></i>Revenue Trends
                </h6>
            </div>
            <div class="card-body">
                <div class="custom-chart" style="height: 300px; position: relative; padding: 20px;">
                    {% if analytics_data.revenue_trends.daily_data %}
                    {% set revenue_values = analytics_data.revenue_trends.daily_data | map(attribute='revenue') | list %}
                    {% set baseline_values = analytics_data.revenue_trends.daily_data | map(attribute='baseline') | list %}
                    {% set all_values = revenue_values + baseline_values %}
                    {% set max_value = all_values | max %}
                    {% for day_data in analytics_data.revenue_trends.daily_data %}
                    <div class="chart-bar-group" style="position: absolute; left: {{ (loop.index0 * 100 / analytics_data.revenue_trends.daily_data|length) }}%; width: {{ 80 / analytics_data.revenue_trends.daily_data|length }}%; height: 100%;">
                        <!-- Current Year Revenue Bar -->
                        <div class="chart-bar ty-bar" style="
                            position: absolute;
                            bottom: 20px;
                            left: 0;
                            width: 45%;
                            height: {{ ((day_data.revenue or 0) / max_value * 70) if max_value > 0 else 0 }}%;
                            background: linear-gradient(to top, #28a745, #71dd8a);
                            border-radius: 2px 2px 0 0;
                        " title="Current Year: ${{ '{:,.0f}'.format(day_data.revenue or 0) }}"></div>
                        <!-- Baseline Revenue Bar -->
                        <div class="chart-bar stly-bar" style="
                            position: absolute;
                            bottom: 20px;
                            right: 0;
                            width: 45%;
                            height: {{ ((day_data.baseline or 0) / max_value * 70) if max_value > 0 else 0 }}%;
                            background: linear-gradient(to top, #6c757d, #adb5bd);
                            border-radius: 2px 2px 0 0;
                        " title="Baseline (STLY): ${{ '{:,.0f}'.format(day_data.baseline or 0) }}"></div>
                        <!-- Date Label -->
                        <div style="position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); font-size: 9px; text-align: center;">
                            {{ day_data.date.strftime('%m/%d') }}
                        </div>
                    </div>
                    {% endfor %}
                    <!-- Legend -->
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 12px;">
                        <div><span style="display: inline-block; width: 15px; height: 15px; background: #28a745; margin-right: 5px;"></span>Current Year</div>
                        <div><span style="display: inline-block; width: 15px; height: 15px; background: #6c757d; margin-right: 5px;"></span>Baseline (STLY)</div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No revenue trend data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Occupancy & ADR Trends -->
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>Occupancy & ADR Trends
                </h6>
            </div>
            <div class="card-body">
                <div class="custom-chart" style="height: 300px; position: relative; padding: 20px;">
                    {% if analytics_data.occupancy_adr.occupancy_trends %}
                    {% for trend in analytics_data.occupancy_adr.occupancy_trends %}
                    <div class="chart-bar-group" style="position: absolute; left: {{ (loop.index0 * 100 / analytics_data.occupancy_adr.occupancy_trends|length) }}%; width: {{ 80 / analytics_data.occupancy_adr.occupancy_trends|length }}%; height: 100%;">
                        <!-- Occupancy Bar (scaled to 100%) -->
                        <div class="chart-bar occupancy-bar" style="
                            position: absolute;
                            bottom: 20px;
                            left: 0;
                            width: 45%;
                            height: {{ (trend.occupancy * 0.7) if trend.occupancy else 0 }}%;
                            background: linear-gradient(to top, #007bff, #66b3ff);
                            border-radius: 2px 2px 0 0;
                        " title="Occupancy: {{ '{:.1f}'.format(trend.occupancy) }}%"></div>
                        <!-- ADR Bar (scaled relative to max ADR) -->
                        {% set max_adr = analytics_data.occupancy_adr.adr_trends | map(attribute='adr') | max %}
                        <div class="chart-bar adr-bar" style="
                            position: absolute;
                            bottom: 20px;
                            right: 0;
                            width: 45%;
                            height: {{ ((analytics_data.occupancy_adr.adr_trends[loop.index0].adr / max_adr * 70) if max_adr > 0 else 0) }}%;
                            background: linear-gradient(to top, #ffc107, #ffeb3b);
                            border-radius: 2px 2px 0 0;
                        " title="ADR: ${{ '{:.0f}'.format(analytics_data.occupancy_adr.adr_trends[loop.index0].adr) }}"></div>
                        <!-- Date Label -->
                        <div style="position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); font-size: 9px; text-align: center;">
                            {{ trend.date.strftime('%m/%d') }}
                        </div>
                    </div>
                    {% endfor %}
                    <!-- Legend -->
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 12px;">
                        <div><span style="display: inline-block; width: 15px; height: 15px; background: #007bff; margin-right: 5px;"></span>Occupancy %</div>
                        <div><span style="display: inline-block; width: 15px; height: 15px; background: #ffc107; margin-right: 5px;"></span>ADR ($)</div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No occupancy/ADR data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hotel Rankings and Forecast Accuracy -->
<div class="row mb-4">
    <!-- Top Performing Hotels -->
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>Top Performing Hotels
                </h6>
            </div>
            <div class="card-body">
                {% if analytics_data.hotel_rankings %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Hotel</th>
                                <th>Revenue Growth</th>
                                <th>Total Revenue</th>
                                <th>Occupancy</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hotel_data in analytics_data.hotel_rankings[:5] %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong>{{ hotel_data.hotel.hotel_name }}</strong>
                                    <br><small class="text-muted">{{ hotel_data.hotel.city }}</small>
                                </td>
                                <td>
                                    {% if hotel_data.revenue_growth >= 0 %}
                                    <span class="text-success">+{{ "{:.1f}".format(hotel_data.revenue_growth) }}%</span>
                                    {% else %}
                                    <span class="text-danger">{{ "{:.1f}".format(hotel_data.revenue_growth) }}%</span>
                                    {% endif %}
                                </td>
                                <td>${{ "{:,.0f}".format(hotel_data.total_revenue) }}</td>
                                <td>{{ "{:.1f}".format(hotel_data.occupancy) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-bar fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No hotel performance data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Forecast Accuracy -->
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bullseye me-2"></i>Forecast Accuracy
                </h6>
            </div>
            <div class="card-body">
                {% if analytics_data.forecast_accuracy.total_forecasts > 0 %}
                <div class="row text-center">
                    <div class="col-4">
                        <div class="p-2">
                            <h5 class="text-primary">{{ "{:.1f}".format(analytics_data.forecast_accuracy.avg_revenue_accuracy) }}%</h5>
                            <small>Revenue Accuracy</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2">
                            <h5 class="text-success">{{ "{:.1f}".format(analytics_data.forecast_accuracy.avg_adr_accuracy) }}%</h5>
                            <small>ADR Accuracy</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2">
                            <h5 class="text-info">{{ "{:.1f}".format(analytics_data.forecast_accuracy.avg_occupancy_accuracy) }}%</h5>
                            <small>Occupancy Accuracy</small>
                        </div>
                    </div>
                </div>
                <hr>
                <p class="text-center text-muted mb-0">
                    Based on {{ analytics_data.forecast_accuracy.total_forecasts }} forecasts
                </p>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-bullseye fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No forecast comparison data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Event Impact Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-calendar-star me-2"></i>Event Impact Analysis
                </h6>
            </div>
            <div class="card-body">
                {% if analytics_data.event_impact %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>City</th>
                                <th>Hotels Affected</th>
                                <th>Revenue Lift</th>
                                <th>Revenue Lift %</th>
                                <th>Event Period</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event_data in analytics_data.event_impact[:8] %}
                            <tr>
                                <td>
                                    <strong>{{ event_data.event.event_name }}</strong>
                                </td>
                                <td>{{ event_data.event.city }}</td>
                                <td>{{ event_data.hotels_affected }}</td>
                                <td>
                                    {% if event_data.revenue_lift >= 0 %}
                                    <span class="text-success">${{ "{:,.0f}".format(event_data.revenue_lift) }}</span>
                                    {% else %}
                                    <span class="text-danger">${{ "{:,.0f}".format(event_data.revenue_lift) }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event_data.revenue_lift_pct >= 0 %}
                                    <span class="badge bg-success">+{{ "{:.1f}".format(event_data.revenue_lift_pct) }}%</span>
                                    {% else %}
                                    <span class="badge bg-danger">{{ "{:.1f}".format(event_data.revenue_lift_pct) }}%</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ event_data.event.start_date.strftime('%m/%d') }} - {{ event_data.event.end_date.strftime('%m/%d') }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No event impact data available for the selected period</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- User Productivity and Market Comparison -->
<div class="row mb-4">
    <!-- User Productivity -->
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-users-cog me-2"></i>User Productivity
                </h6>
            </div>
            <div class="card-body">
                {% if analytics_data.user_productivity %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Forecasts</th>
                                <th>Hotels</th>
                                <th>Task Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_data in analytics_data.user_productivity[:5] %}
                            <tr>
                                <td>{{ user_data.username }}</td>
                                <td>{{ user_data.forecast_count }}</td>
                                <td>{{ user_data.hotels_worked }}</td>
                                <td>
                                    <span class="badge bg-info">{{ "{:.0f}".format(user_data.task_completion_rate) }}%</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No user activity data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Market Comparison -->
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i>Market Performance
                </h6>
            </div>
            <div class="card-body">
                {% if analytics_data.market_comparison %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>City</th>
                                <th>Hotels</th>
                                <th>Revenue Growth</th>
                                <th>Occupancy</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for market_data in analytics_data.market_comparison[:5] %}
                            <tr>
                                <td>{{ market_data.city }}</td>
                                <td>{{ market_data.hotel_count }}</td>
                                <td>
                                    {% if market_data.revenue_growth >= 0 %}
                                    <span class="text-success">+{{ "{:.1f}".format(market_data.revenue_growth) }}%</span>
                                    {% else %}
                                    <span class="text-danger">{{ "{:.1f}".format(market_data.revenue_growth) }}%</span>
                                    {% endif %}
                                </td>
                                <td>{{ "{:.1f}".format(market_data.occupancy) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-globe fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No market comparison data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Export and Actions -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h6 class="mb-3">Export & Reports</h6>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-2"></i>Export to Excel
                    </button>
                    <button class="btn btn-outline-secondary" onclick="generatePDF()">
                        <i class="fas fa-file-pdf me-2"></i>Generate PDF Report
                    </button>
                    <button class="btn btn-outline-info" onclick="emailReport()">
                        <i class="fas fa-envelope me-2"></i>Email Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Custom chart interactions for analytics dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to custom chart bars
    const chartBars = document.querySelectorAll('.chart-bar');
    chartBars.forEach(bar => {
        bar.addEventListener('mouseenter', function() {
            this.style.opacity = '0.8';
            this.style.transform = 'scaleY(1.05)';
            this.style.transition = 'all 0.2s ease';
        });
        
        bar.addEventListener('mouseleave', function() {
            this.style.opacity = '1';
            this.style.transform = 'scaleY(1)';
        });
    });
});

// Export Functions
function exportToExcel() {
    // Implementation for Excel export
    alert('Excel export functionality will be implemented');
}

function generatePDF() {
    // Implementation for PDF generation
    alert('PDF generation functionality will be implemented');
}

function emailReport() {
    // Implementation for email report
    alert('Email report functionality will be implemented');
}
</script>
{% endblock %}