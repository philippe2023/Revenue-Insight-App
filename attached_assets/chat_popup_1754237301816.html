<!-- Chat Popup Widget -->
<div id="chatPopup" class="chat-popup" style="display: none;">
    <div class="chat-popup-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-robot me-2"></i>
                <strong>AI Assistant</strong>
            </div>
            <div>
                <button id="chatMinimize" class="btn btn-sm btn-outline-light me-1">
                    <i class="fas fa-minus"></i>
                </button>
                <button id="chatClose" class="btn btn-sm btn-outline-light">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="chat-popup-body">
        <div id="chatPopupMessages" class="chat-popup-messages">
            <div class="message assistant">
                <strong>AI:</strong> Hello! Ask me about your hotels, events, or forecasts.
            </div>
        </div>
        
        <div id="chatPopupTyping" class="typing-indicator" style="display: none;">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            AI is thinking...
        </div>
    </div>
    
    <div class="chat-popup-footer">
        <div class="input-group">
            <input type="text" id="chatPopupInput" class="form-control form-control-sm" 
                   placeholder="Ask about hotels, events..." autocomplete="off">
            <button id="chatPopupSend" class="btn btn-primary btn-sm">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="chat-popup-actions mt-2">
            <a href="{{ url_for('chat') }}" class="btn btn-outline-secondary btn-sm me-2">
                <i class="fas fa-expand me-1"></i>Full Chat
            </a>
            <button id="chatHistory" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-history me-1"></i>History
            </button>
        </div>
    </div>
</div>

<!-- Chat Toggle Button -->
<button id="chatToggle" class="chat-toggle-btn">
    <i class="fas fa-comments"></i>
    <span class="chat-badge" id="chatBadge" style="display: none;">1</span>
</button>

<!-- Chat History Modal -->
<div class="modal fade" id="chatHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i>Chat History
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="chatHistoryList">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading conversations...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="newChatBtn" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>New Chat
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.chat-popup {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 350px;
    max-height: 500px;
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1050;
    display: flex;
    flex-direction: column;
}

.chat-popup-header {
    background: var(--bs-primary);
    color: white;
    padding: 0.75rem;
    border-radius: 10px 10px 0 0;
}

.chat-popup-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 300px;
    max-height: 350px;
}

.chat-popup-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    max-height: 300px;
}

.chat-popup-footer {
    padding: 0.75rem;
    border-top: 1px solid var(--bs-border-color);
}

.chat-toggle-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--bs-primary);
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    font-size: 1.5rem;
    z-index: 1040;
    transition: all 0.3s ease;
}

.chat-toggle-btn:hover {
    background: var(--bs-primary);
    transform: scale(1.1);
    color: white;
}

.chat-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--bs-danger);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-popup .message {
    margin-bottom: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    max-width: 85%;
    word-wrap: break-word;
}

.chat-popup .message.user {
    background: var(--bs-primary);
    color: white;
    margin-left: auto;
    text-align: right;
}

.chat-popup .message.assistant {
    background: var(--bs-light);
    border: 1px solid var(--bs-border-color);
}

[data-bs-theme="dark"] .chat-popup .message.assistant {
    background: var(--bs-dark);
    border-color: var(--bs-secondary);
}

.chat-popup .typing-indicator {
    padding: 0.5rem 0.75rem;
    background: var(--bs-light);
    border-radius: 0.5rem;
    max-width: 150px;
    margin: 0.5rem;
}

.chat-history-item {
    padding: 0.75rem;
    border: 1px solid var(--bs-border-color);
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.chat-history-item:hover {
    background: var(--bs-light);
}

[data-bs-theme="dark"] .chat-history-item:hover {
    background: var(--bs-dark);
}

.chat-history-preview {
    font-size: 0.9rem;
    color: var(--bs-secondary);
    margin-top: 0.25rem;
}

@media (max-width: 768px) {
    .chat-popup {
        width: calc(100vw - 40px);
        right: 20px;
        left: 20px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatToggle = document.getElementById('chatToggle');
    const chatPopup = document.getElementById('chatPopup');
    const chatClose = document.getElementById('chatClose');
    const chatMinimize = document.getElementById('chatMinimize');
    const chatPopupInput = document.getElementById('chatPopupInput');
    const chatPopupSend = document.getElementById('chatPopupSend');
    const chatPopupMessages = document.getElementById('chatPopupMessages');
    const chatPopupTyping = document.getElementById('chatPopupTyping');
    const chatHistory = document.getElementById('chatHistory');
    const chatHistoryModal = new bootstrap.Modal(document.getElementById('chatHistoryModal'));
    const newChatBtn = document.getElementById('newChatBtn');
    
    let currentConversationId = null;
    let isPopupMinimized = false;

    // Toggle chat popup
    chatToggle.addEventListener('click', function() {
        if (chatPopup.style.display === 'none') {
            chatPopup.style.display = 'flex';
            chatToggle.style.display = 'none';
            loadOrCreateConversation();
        }
    });

    // Close chat popup
    chatClose.addEventListener('click', function() {
        chatPopup.style.display = 'none';
        chatToggle.style.display = 'block';
    });

    // Minimize chat popup
    chatMinimize.addEventListener('click', function() {
        isPopupMinimized = !isPopupMinimized;
        if (isPopupMinimized) {
            chatPopup.style.height = '60px';
            document.querySelector('.chat-popup-body').style.display = 'none';
            document.querySelector('.chat-popup-footer').style.display = 'none';
            chatMinimize.innerHTML = '<i class="fas fa-plus"></i>';
        } else {
            chatPopup.style.height = 'auto';
            document.querySelector('.chat-popup-body').style.display = 'flex';
            document.querySelector('.chat-popup-footer').style.display = 'block';
            chatMinimize.innerHTML = '<i class="fas fa-minus"></i>';
        }
    });

    // Send message function
    function sendPopupMessage() {
        const message = chatPopupInput.value.trim();
        if (!message) return;

        addPopupMessage(message, 'user');
        chatPopupInput.value = '';
        showPopupTyping();

        fetch('/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: message,
                conversation_id: currentConversationId
            })
        })
        .then(response => response.json())
        .then(data => {
            hidePopupTyping();
            if (data.success) {
                addPopupMessage(data.response, 'assistant');
                currentConversationId = data.conversation_id;
            } else {
                addPopupMessage('Sorry, I encountered an error: ' + data.error, 'assistant');
            }
        })
        .catch(error => {
            hidePopupTyping();
            addPopupMessage('Sorry, I encountered an error processing your request.', 'assistant');
        });
    }

    // Add message to popup
    function addPopupMessage(message, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        if (sender === 'user') {
            messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
        } else {
            messageDiv.innerHTML = `<strong>AI:</strong> ${message}`;
        }
        
        chatPopupMessages.appendChild(messageDiv);
        chatPopupMessages.scrollTop = chatPopupMessages.scrollHeight;
    }

    function showPopupTyping() {
        chatPopupTyping.style.display = 'block';
        chatPopupMessages.scrollTop = chatPopupMessages.scrollHeight;
    }

    function hidePopupTyping() {
        chatPopupTyping.style.display = 'none';
    }

    // Load or create conversation
    function loadOrCreateConversation() {
        fetch('/chat/conversation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentConversationId = data.conversation_id;
                loadConversationMessages(currentConversationId);
            }
        });
    }

    // Load conversation messages
    function loadConversationMessages(conversationId) {
        fetch(`/chat/conversation/${conversationId}/messages`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                chatPopupMessages.innerHTML = '';
                data.messages.forEach(msg => {
                    if (msg.is_user_message) {
                        addPopupMessage(msg.message_text, 'user');
                    }
                    if (msg.response_text) {
                        addPopupMessage(msg.response_text, 'assistant');
                    }
                });
            }
        });
    }

    // Event listeners
    chatPopupInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendPopupMessage();
    });
    
    chatPopupSend.addEventListener('click', sendPopupMessage);

    // Chat history
    chatHistory.addEventListener('click', function() {
        loadChatHistory();
        chatHistoryModal.show();
    });

    function loadChatHistory() {
        fetch('/chat/conversations')
        .then(response => response.json())
        .then(data => {
            const historyList = document.getElementById('chatHistoryList');
            if (data.success && data.conversations.length > 0) {
                historyList.innerHTML = data.conversations.map(conv => `
                    <div class="chat-history-item" data-conversation-id="${conv.id}">
                        <div class="d-flex justify-content-between">
                            <strong>${conv.title || 'Untitled Chat'}</strong>
                            <small class="text-muted">${new Date(conv.created_at).toLocaleDateString()}</small>
                        </div>
                        <div class="chat-history-preview">${conv.preview || 'No messages yet'}</div>
                    </div>
                `).join('');
                
                // Add click handlers
                document.querySelectorAll('.chat-history-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const convId = this.dataset.conversationId;
                        currentConversationId = parseInt(convId);
                        loadConversationMessages(currentConversationId);
                        chatHistoryModal.hide();
                    });
                });
            } else {
                historyList.innerHTML = '<div class="text-center text-muted">No conversations yet</div>';
            }
        });
    }

    // New chat
    newChatBtn.addEventListener('click', function() {
        currentConversationId = null;
        chatPopupMessages.innerHTML = '<div class="message assistant"><strong>AI:</strong> Hello! Ask me about your hotels, events, or forecasts.</div>';
        chatHistoryModal.hide();
    });
});
</script>